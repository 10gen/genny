# Inspired by SERVER-20409. This workload steadily spawns new
# threads. Each thread inserts a small document, and then sleeps for
# an adjustable amount of time. The point is to stress the number of
# connections without totally maxing out the server.
#
# Note: this workload will spawn a lot of threads on the client and
# the server. If your machine hits a limit on number of threads, the
# workload will crash.

spawnPeriodMs: &spawnPeriodMs 10 # Period between spawning a new thread
insertSleepMs: &insertSleepMs 100 # Time to sleep between inserts
maxThreads: &maxThreads 15000 # Total number of threads to spawn

  
main:
  name: IncreasingThreads
  runLengthMs: 300000
  nodes:
    - type: drop
    - type: ForN
      node: newThread
      N: *maxThreads
      next: Finish
    - type: spawn
      name: newThread
      print: Spawning threads
      spawn: slowinsert
    - type: sleep
      sleepMs: *spawnPeriodMs
      next: Finish
    - name: slowinsert
      type: insert_one
      document: {x : a}
    - type: sleep
      sleepMs: *insertSleepMs
      next: slowinsert
        
      
      