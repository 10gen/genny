SchemaVersion: 2018-07-01
Owner: "@mongodb/product-perf"
Description: |
  Workload to Benchmark the effect of LongLivedTransactions on an Insert workload.

GlobalDefaults:
  # These values should match those are the top of LLTPhases.yml
  dbname: &dbname llt
  SecondaryDocumentCount: &SecondaryNumDocs 10000000
  CollectionCount: &InsertCollectionCount 4

Clients:
  Default:
    QueryOptions:
      maxPoolSize: 500

ActorTemplates:
  - TemplateName: LoaderTemplate
    Config:
      Name: {^Parameter: {Name: "Name", Default: "InitialLoad"}}
      Type: Loader
      Database: *dbname
      ClientName: Loader
      Threads: 4
      Phases:
        OnlyActiveInPhases:
          Active: [{^Parameter: {Name: "OnlyActiveInPhase", Default: 1}}]
          NopInPhasesUpTo: 11
          PhaseConfig:
            ExternalPhaseConfig:
              Path: ../../phases/scale/LLTPhases.yml
              Key: LoaderPhase

  - TemplateName: QuiesceTemplate
    Config:
      Name: QuiescePhase
      Type: QuiesceActor
      Database: *dbname
      ClientName: Quiesce
      Threads: 1
      Phases:
        OnlyActiveInPhases:
          Active: [3, 5, 7, 9, 11]
          NopInPhasesUpTo: 11

  - TemplateName: InsertTemplate.100.50
    Config:
      Name: {^Parameter: {Name: "Name", Default: "InsertBaseline.100"}}
      Type: CrudActor
      Database: *dbname
      ClientName: Insert
      Threads: 1
      GlobalRate: 400 per 1 second
      Phases:
        OnlyActiveInPhases:
          Active: [{^Parameter: {Name: "OnlyActiveInPhase", Default: 4}}]
          NopInPhasesUpTo: 11
          PhaseConfig:
            ExternalPhaseConfig:
              Path: ../../phases/scale/LLTPhases.yml
              Key: InsertPhase

  - TemplateName: InsertTemplate.800.50
    Config:
      Name: {^Parameter: {Name: "Name", Default: "InsertBaseline.800"}}
      Type: CrudActor
      Database: *dbname
      ClientName: Insert
      Threads: 8
      GlobalRate: 6400 per 1 second
      Phases:
        OnlyActiveInPhases:
          Active: [{^Parameter: {Name: "OnlyActiveInPhase", Default: 8}}]
          NopInPhasesUpTo: 11
          PhaseConfig:
            ExternalPhaseConfig:
              Path: ../../phases/scale/LLTPhases.yml
              Key: InsertPhase


Actors:
  - ActorFromTemplate:
      TemplateName: LoaderTemplate
      TemplateParameters:
        Name: InitialLoad

  - ActorFromTemplate:
      TemplateName: LoaderTemplate
      TemplateParameters:
        Name: InitialLoadWithIndexes
        DocumentCount: *SecondaryNumDocs
        OnlyActiveInPhase: 2
        Indexes: {}

  - Name: QuiescePhase
    Type: QuiesceActor
    Threads: 1
    Database: test
    Phases:
      OnlyActiveInPhases:
        Active: [3, 5, 7, 9]
        NopInPhasesUpTo: 11
        PhaseConfig:
          Repeat: 1

  - ActorFromTemplate:
      TemplateName: QuiesceTemplate
      TemplateParameters: {}

  # <-----  4 threads @ 100 ops / second in batches of 50
  # <-----  Baseline: Phase 3
  - ActorFromTemplate:
      TemplateName: InsertTemplate.100.50
      TemplateParameters:
        Name: InsertBaseline.100.50
        Collection: Collection0

  - ActorFromTemplate:
      TemplateName: InsertTemplate.100.50
      TemplateParameters:
        Name: InsertBaseline.100.50
        Collection: Collection1

  - ActorFromTemplate:
      TemplateName: InsertTemplate.100.50
      TemplateParameters:
        Name: InsertBaseline.100.50
        Collection: Collection2

  - ActorFromTemplate:
      TemplateName: InsertTemplate.100.50
      TemplateParameters:
        Name: InsertBaseline.100.50
        Collection: Collection3

  # <-----  Benchmark
  - ActorFromTemplate:
      TemplateName: InsertTemplate.100.50
      TemplateParameters:
        Name: InsertBenchmark.100.50
        Collection: Collection0
        OnlyActiveInPhase: 6

  - ActorFromTemplate:
      TemplateName: InsertTemplate.100.50
      TemplateParameters:
        Name: InsertBenchmark.100.50
        Collection: Collection1
        OnlyActiveInPhase: 6

  - ActorFromTemplate:
      TemplateName: InsertTemplate.100.50
      TemplateParameters:
        Name: InsertBenchmark.100.50
        Collection: Collection2
        OnlyActiveInPhase: 6

  - ActorFromTemplate:
      TemplateName: InsertTemplate.100.50
      TemplateParameters:
        Name: InsertBenchmark.100.50
        Collection: Collection3
        OnlyActiveInPhase: 6

  # <-----  TODO: add LLT Benchmark Workload PERF-2177
  # <-----  LLT Benchmark: Phase 8

  # <-----  4 threads @ 800 ops / second in batches of 50
  # <-----  Baseline: Phase 8
  - ActorFromTemplate:
      TemplateName: InsertTemplate.800.50
      TemplateParameters:
        Name: InsertBaseline.800.50
        Collection: Collection0

  - ActorFromTemplate:
      TemplateName: InsertTemplate.800.50
      TemplateParameters:
        Name: InsertBaseline.800.50
        Collection: Collection1

  - ActorFromTemplate:
      TemplateName: InsertTemplate.800.50
      TemplateParameters:
        Name: InsertBaseline.800.50
        Collection: Collection2

  - ActorFromTemplate:
      TemplateName: InsertTemplate.800.50
      TemplateParameters:
        Name: InsertBaseline.800.50
        Collection: Collection3

  #  # <-----  Benchmark
  - ActorFromTemplate:
      TemplateName: InsertTemplate.800.50
      TemplateParameters:
        Name: InsertBenchmark.800.50
        Collection: Collection0
        OnlyActiveInPhase: 10

  - ActorFromTemplate:
      TemplateName: InsertTemplate.800.50
      TemplateParameters:
        Name: InsertBenchmark.800.50
        Collection: Collection1
        OnlyActiveInPhase: 10

  - ActorFromTemplate:
      TemplateName: InsertTemplate.800.50
      TemplateParameters:
        Name: InsertBenchmark.800.50
        Collection: Collection2
        OnlyActiveInPhase: 10

  - ActorFromTemplate:
      TemplateName: InsertTemplate.800.50
      TemplateParameters:
        Name: InsertBenchmark.800.50
        Collection: Collection3
        OnlyActiveInPhase: 10

  # <-----  TODO: add LLT Benchmark Workload PERF-2177
  # <-----  LLT Benchmark: Phase 10

AutoRun:
  Requires:
    mongodb_setup:
      - replica
      - single-replica
