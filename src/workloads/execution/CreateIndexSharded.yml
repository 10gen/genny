SchemaVersion: 2018-07-01
Owner: "@mongodb/sharding"

Actors:
- Name: InsertData
  Type: Loader
  Threads: 1
  Phases:
  - ExternalPhaseConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: InsertData
      Parameters:
        db: &db test
  - &Nop {Nop: true}
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: EnableSharding
  Type: AdminCommand
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 1
    Database: admin
    Operations:
    - OperationMetricsName: EnableSharding
      OperationName: AdminCommand
      OperationCommand:
        enableSharding: *db
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: CreateShardKeyIndex
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - Repeat: 1
    Database: *db
    Operations:
    - OperationMetricsName: CreateShardKeyIndex
      OperationName: RunCommand
      OperationCommand:
        createIndexes: Collection0 # This is the default collection populated by the Loader.
        indexes:
        - key:
            _id: hashed
          name: _id_1
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: ShardCollection
  Type: AdminCommand
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - Repeat: 1
    Database: admin
    Operations:
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0
        key:
          _id: hashed
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: IndexCollection
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - ExternalPhaseConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: Create2dIndexesCmd
      Parameters:
        Duration: 5 minutes
  - ExternalPhaseConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: Create2dSphereIndexesCoordCmd
      Parameters:
        Duration: 5 minutes
  - ExternalPhaseConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: Create2dSphereGeoJsonIndexesCmd
      Parameters:
        Duration: 5 minutes
  - ExternalPhaseConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: CreateGeoHaystackIndexesCmd
      Parameters:
        Duration: 5 minutes
  - ExternalPhaseConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: CreateHashedIndexesCmd
      Parameters:
        Duration: 5 minutes
  - ExternalPhaseConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: CreateTextIndexesCmd
      Parameters:
        Duration: 5 minutes
  - ExternalPhaseConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: CreateWildCardIndexesCmd
      Parameters:
        Duration: 5 minutes

AutoRun:
  Requires:
    bootstrap:
      mongodb_setup:
        - shard
        - shard-lite
