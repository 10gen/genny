---

# Syntax is inspired by the Crud driver specs:
# https://github.com/mongodb/specifications/tree/master/source/crud/tests
# but modified for casing and to eliminate some boilerplate. Idea is that
# if we wanted to translate these tests to exactly the above spec it could
# be a trivial data-format conversion.
#
# Exception to this:
#
# - OutcomeCounts: is a shortcut these tests take to avoid having to
#   specify every single document in the collection.
#
# - Error: indicates a string of what type of error (syntax error
#   encountered during setup or a runtime error
#
# - name: (omitted) we always assume everything happens on the same db and collection
#
# - ExpectedCollectionsExist: allows tests to assert that a collection has been
#   created or dropped.
#

Tests:

  - Description: Inserts documents into the database.
    Operations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
    OutcomeData:
      - {a: 1}

  - Description: BulkWrite insert, delete, then re-insert
    Operations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
            - WriteCommand: deleteOne
              Filter: { a: 1 }
            - WriteCommand: insertOne
              Document: { a: 2 }
    OutcomeData:
      - {a: 2}

  - Description: Inserts and updates document in the database.
    Operations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
            - WriteCommand: updateOne
              Filter: { a: 1 }
              Update: { $set: { a: 5 } }
    OutcomeData:
      - {a: 5}

  - Description: Inserts and deletes documents in the database.
    Operations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
            - WriteCommand: deleteOne
              Filter: { a: 1 }
            - WriteCommand: insertOne
              Document: { a: 2 }
    OutcomeData:
      - {a: 2}

  - Description: Inserts and replaces document in the database.
    Operations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
            - WriteCommand: replaceOne
              Filter: { a : 1 }
              Replacement: { name: test }
    OutcomeData:
      - {name: test}

  - Description: Inserts and updates with 'BypassDocumentValidation' true and 'Ordered' false.
    Operations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
            - WriteCommand: updateOne
              Filter: { a: 1 }
              Update: { $set: { a: 5 } }
          Options:
            Ordered: false
            BypassDocumentValidation: true
    OutcomeData:
      - {a: 5}
    ExpectAllEvents:
      Ordered: false
      BypassDocumentValidation: true

  - Description: Inserts and updates many documents in the database.
    Operations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: {^RandomInt: {min: 5, max: 15} } }
            - WriteCommand: insertOne
              Document: { a: {^RandomInt: {min: 5, max: 15} } }
            - WriteCommand: insertOne
              Document: { a: {^RandomInt: {min: 5, max: 15} } }
            - WriteCommand: updateMany
              Filter: { a: {$gte: 5} }
              Update: { $set: { a: 1 } }
    OutcomeCounts:
      - Filter: {a: 1}
        Count: 3

  - Description: Inserts and deletes many documents in the database.
    Operations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: {^RandomInt: {min: 5, max: 15} } }
            - WriteCommand: insertOne
              Document: { a: {^RandomInt: {min: 5, max: 15} } }
            - WriteCommand: insertOne
              Document: { a: {^RandomInt: {min: 5, max: 15} } }
            - WriteCommand: deleteMany
              Filter: { a: {$gte: 5} }
    OutcomeCounts:
      - Filter: {a: {$gte: 5}}
        Count: 0

  - Description: Insert randomly generated doc and update with write concern majority.
    Operations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: {^RandomInt: {min: 2, max: 5} }}
            - WriteCommand: updateOne
              Filter: { a: { $gte: 2 } }
              Update: { $set: { a: 8 } }
          Options:
            WriteConcern:
              Level: majority
              Timeout: 6000 milliseconds
    OutcomeCounts:
      - Filter: {a: 8}
        Count: 1
    ExpectAllEvents:
      W: majority
      WTimeout: 6000

  - Description: Write concern without 'Level' field should throw.
    Operations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
            - WriteCommand: updateOne
              Filter: { a: 1 }
              Update: { $set: { a: 5 } }
          Options:
            WriteConcern:
              Timeout: 3000 milliseconds
              Journal: false
    Error: |
      yaml-cpp: error at line 176, column 15: bad conversion

  - Description: The 'test' collection is dropped with write concern majority.
    Operations:
      - OperationName: drop
        OperationCommand:
          Collection: test
    ExpectedCollectionsExist:
      test: false

  - Description: Write concern majority with timeout.
    Operations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
            - WriteCommand: updateOne
              Filter: { a: 1 }
              Update: { $set: { a: 5 } }
          Options:
            WriteConcern:
              Level: majority
              Timeout: 5000 milliseconds
    ExpectAllEvents:
      W: majority
      WTimeout: 5000

  - Description: Write concern 1 with timeout and journalling true.
    Operations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
            - WriteCommand: updateOne
              Filter: { a: 1 }
              Update: { $set: { a: 5 } }
          Options:
            WriteConcern:
              Level: 1
              Timeout: 2500 milliseconds
              Journal: true
    ExpectAllEvents:
      W: 1
      WTimeout: 2500
      J: true
