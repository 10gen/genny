---

Cases:

  - Name: Inserts documents into the database.
    WhenRunOperations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
    # syntax sugar for
    # ThenHasCounts: [{Filter: {a: 1}, Count: 1}]
    ThenHaveDocuments:
      - {a: 1}

  - Name: BulkWrite insert, delete, then re-insert
    GivenDocuments: {}
    WhenRunOperations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
            - WriteCommand: deleteOne
              Filter: { a: 1 }
            - WriteCommand: insertOne
              Document: { a: 2 }
    ThenHaveDocuments:
      - {a: 2}

  - Name: Inserts and updates document in the database.
    WhenRunOperations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
            - WriteCommand: updateOne
              Filter: { a: 1 }
              Update: { $set: { a: 5 } }
    ThenHaveDocuments:
      - {a: 5}

  - Name: Inserts and deletes documents in the database.
    WhenRunOperations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
            - WriteCommand: deleteOne
              Filter: { a: 1 }
            - WriteCommand: insertOne
              Document: { a: 2 }
    ThenHaveDocuments:
      - {a: 2}

  - Name: Inserts and replaces document in the database.
    WhenRunOperations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
            - WriteCommand: replaceOne
              Filter: { a : 1 }
              Replacement: { name: test }
    ThenHaveDocuments:
      - {name: test}

  - Name: Inserts and updates with 'BypassDocumentValidation' true and 'Ordered' false.
    WhenRunOperations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
            - WriteCommand: updateOne
              Filter: { a: 1 }
              Update: { $set: { a: 5 } }
          Options:
            Ordered: false
            BypassDocumentValidation: true
        ThenHaveDocuments:
          - {a: 5}
        AndEvents:
          - {ordered: false, bypassDocumentValidation: true}

  - Name: Inserts and updates many documents in the database.
    WhenRunOperations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: {^RandomInt: {min: 5, max: 15} } }
            - WriteCommand: insertOne
              Document: { a: {^RandomInt: {min: 5, max: 15} } }
            - WriteCommand: insertOne
              Document: { a: {^RandomInt: {min: 5, max: 15} } }
            - WriteCommand: updateMany
              Filter: { a: {$gte: 5} }
              Update: { $set: { a: 1 } }
    ThenHasCounts:
      - Filter: {a: 1}
        Count: 3

  - Name: Inserts and deletes many documents in the database.
    WhenRunOperations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: {^RandomInt: {min: 5, max: 15} } }
            - WriteCommand: insertOne
              Document: { a: {^RandomInt: {min: 5, max: 15} } }
            - WriteCommand: insertOne
              Document: { a: {^RandomInt: {min: 5, max: 15} } }
            - WriteCommand: deleteMany
              Filter: { a: {$gte: 5} }
    ThenHasCounts:
      - Filter: {a: {$gte: 5}}
        Count: 0

  - Name: Insert randomly generated doc and update with write concern majority.
    WhenRunOperations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: {^RandomInt: {min: 2, max: 5} }}
            - WriteCommand: updateOne
              Filter: { a: { $gte: 2 } }
              Update: { $set: { a: 8 } }
          Options:
            WriteConcern:
              Level: majority
              Timeout: 6000 milliseconds
    ThenHasCounts:
      - Filter: {a: 8}
        Count: 1
    AndEvents:
      - writeConcern: {w: majority, wtimeout: 6000}

  - Name: Write concern without 'Level' field should throw.
    WhenRunOperations:
      - OperationName: bulkWrite
        OperationCommand:
          WriteOperations:
            - WriteCommand: insertOne
              Document: { a: 1 }
            - WriteCommand: updateOne
              Filter: { a: 1 }
              Update: { $set: { a: 5 } }
          Options:
            WriteConcern:
              Timeout: 3000 milliseconds
              Journal: false
    ThenThrows: InvalidSyntax

  - Name: The 'test' collection is dropped with write concern majority.
    WhenRunOperations:
      - Repeat: 1
        Collection: test
        Operation:
          OperationName: drop
    ThenCollectionExists:
      test: false
